## Autoincremento, Patrones y Triggers

- Autoincremento, es secuencial, de forma automatica cada nuevo registro
- El valor desde donde se inicia la secuencia es 1, pero puede ser definida
- Solo puede existir un campo automaticament por tabla y debe ser una llave primaria
- Al usar un INSERT se puede forzar el valor de ese valor autoincremental.
- No importa si se le asigna un valor null el igual se autoasigna el que sigue

```sql
    -- asumiento esta tabla:
    CREATE TABLE TAB_IDENTITY2 (
                                ID INT AUTO_INCREMENT, 
                                DESCRIPTOR VARCHAR(20), 
                                PRIMARY KEY(ID));
    -- puede omitir el id igual si es autoincremental el se asigna solo
    INSERT INTO TAB_IDENTITY2 (DESCRIPTOR) VALUES ('CLIENTE1');

    -- puede definir el dato como nullo pero igual se autoasigna, no da error
    INSERT INTO TAB_IDENTITY2 (ID, DESCRIPTOR) VALUES (NULL, 'CLIENTE4');

    -- puede fijar un valor valido de id, forzandolo.
    INSERT INTO TAB_IDENTITY2 (ID, DESCRIPTOR) VALUES (100, 'CLIENTE100');

```

### Definiendo patrones de Campo.

- Se pueden definir valores por defecto en una columna DEFAULT VALOR;

```SQL
    CREATE TABLE TB_DEFAULT(
        ID AUTO_INCREMENT,
        DESCRIPCION VARCHAR(50) NOT NULL,
        DIRECCION VARCHAR(100) NULL,
        CIUDAD VARCHAR(50) DEAFULT 'MONTERREY',
        FECHA TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),
        PRIMARY KEY(ID)
    );
    -- INSERTAR UN DATOS CON EL VALOR DESEADO
    INSERT INTO TB_DEFAULT
            (DESCRIPCION, DIRECCION, CIUDAD, FECHA)
            VALUES
            ('CLIENTE X', 'CALLE SOL,525','CANCUN','2024-05-01');
    
    -- INSERTAR UN DATOS CON EL VALOR POR DEFECTO
    INSERT INTO TB_DEFAULT
            (DESCRIPCION)
            VALUES
            ('CLIENTE Y');
            -- LOS DEMAS DATOS SE AGREGAN DEPENDIENDO COMO HAYAN SIDO CONFIGURADOS
```


### TRIGGERS

- Es un tipo de procedimiento almacenado que se ejecuta cuando un evento ocurre en el servidor de bases de datos
- Por ejemplo se puede usar de log
- Se usa **DELIMETER //** */ que significa que se va a ejecutar hasta que se encuentre otro **//** 
- se puede usar otro DELIMITER COMO DELIMITER $$ lo importante es que le dice al interprete que existe un bloque se que ejecutar√° de manera continua hasta conseguir el $$ o // lo que se coloque
- 

```sql
    CREATE TRIGGER
    BEFORE | AFTER
    EVENTOS: INSERT | UPDATE | DELETE
```

```sql
    -- EJEMPLO SE CREA UNA TABLA DE FACTURAS
    CREATE TABLE TB_FACTURACION(
                    FECHA DATE NULL,
                    VENTA_TOTAL FLOAT
    );

    -- ejemplo trigger en bd jugos:
    DELIMITER //
        CREATE  TRIGGER TG_FACTURA
                AFTER INSERT ON TB_ITEMS_FACTURA
                FOR EACH ROW BEGIN
                                -- CODIGO
                             END //
    DELIMITER;   

    -- ejemplo jugos cuando inserten un dato

    DELIMITER //
        CREATE TRIGGER TG_FACTURACION_INSERT 
            AFTER INSERT ON tb_items_facturas1
            FOR EACH ROW 
            BEGIN
                DELETE FROM tb_facturacion;
                INSERT INTO tb_facturacion
                    SELECT  A.FECHA, 
                            SUM(B.CANTIDAD * B.PRECIO) AS VENTA_TOTAL
                    FROM tb_factura1 A
                    INNER JOIN tb_items_facturas1 B
                        ON A.NUMERO = B.NUMERO
                    GROUP BY A.FECHA;
            END //  
```


### Calculando la edad

```sql
    SELECT  DNI, 
            EDAD, 
            FECHA_NACIMIENTO, 
            timestampdiff(YEAR, FECHA_NACIMIENTO, NOW()) AS ANOS 
    FROM tb_clientes;
```

#### TRIGGERS CON UPDATE / DELETE

- Se recomienda usar procedimientos almacenados
- La idea es que el triggers llame al procedimiento

**UPDATE**

```sql
    -- triggers para update
    DELIMITER //
        CREATE TRIGGER TG_FACTURACION_DELETE
        AFTER DELETE ON tb_items_facturas1
        FOR EACH ROW 
        BEGIN
            DELETE FROM tb_facturacion;
            INSERT INTO tb_facturacion
            SELECT  A.FECHA, 
                    SUM(B.CANTIDAD * B.PRECIO) AS VENTA_TOTAL
            FROM tb_factura1 A
            INNER JOIN tb_items_facturas1 B
                ON A.NUMERO = B.NUMERO
            GROUP BY A.FECHA;   
        END //   

```

**DELETE**

```sql
    DELIMITER //
        CREATE TRIGGER TG_FACTURACION_UPDATE
        AFTER UPDATE ON tb_items_facturas1
        FOR EACH ROW 
        BEGIN
            DELETE FROM tb_facturacion;
            INSERT INTO tb_facturacion
            SELECT  A.FECHA, 
                    SUM(B.CANTIDAD * B.PRECIO) AS VENTA_TOTAL
            FROM tb_factura1 A
            INNER JOIN tb_items_facturas1 B
                    ON A.NUMERO = B.NUMERO
            GROUP BY A.FECHA;
        END //
```


#### MANIPULACION DE DATOS

- Con procedimientos almacenados
- Herramientas ETL (pentaho, power center, sap data services, sql server information services)
- Programacion con Python, PHP, .NET 
- ETL: extraer transformar descargar
- 