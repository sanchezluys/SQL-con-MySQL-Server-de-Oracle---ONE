## Cursor y Funcion

### Problema con SELECT INTO

- Un select into asigna un solo valor a la variable
- y si se desea guardar un listado? como un array?

### CURSOR
- En ese caso se usa CURSOR
- permite interaccion linea por linea mediante un orden determinado
- El cursor te da un control más granular sobre los datos y te permite realizar acciones más complejas que un SELECT simple

Fases del CURSOR:

- DECLARACION: Definir la consulta que será depositada en el cursor
- ABERTURA: Abrimos el cursor para recorrerlo una linea a la vez
- RECORRIDO: linea por linea hasta el final
- CIERRE: cerramos el cursor
- LIMPIAR: limpia el cursor de la memoria


Ejemplo de un cursor
- Con un limite,
- En la realidad es muy posible que no se conozca el tamaño del cursor

```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `cursor_1`;
    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE PROCEDURE `cursor_1` ()
        BEGIN
            DECLARE vnombre VARCHAR(50);
            DECLARE c 	CURSOR FOR
                        SELECT NOMBRE 
                        FROM tabla_de_clientes
                        LIMIT 4;
            OPEN c;
                FETCH c INTO vnombre;
                SELECT vnombre;
                FETCH c INTO vnombre;
                SELECT vnombre;
                FETCH c INTO vnombre;
                SELECT vnombre;
                FETCH c INTO vnombre;
                SELECT vnombre;
            CLOSE c;
        END$$
    DELIMITER ;
```

### LOOPING CON CURSOR
- Se hace un barrido con while por ejemplo.
- se usa un handler para manejar el error

```SQL
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `cursor_looping`;
    DELIMITER $$
    USE `credicel_alura_bd`$$
    CREATE PROCEDURE `cursor_looping` ()
    BEGIN
        DECLARE fin_c INT DEFAULT 0;
        DECLARE vnombre VARCHAR(50);
        DECLARE c 	CURSOR FOR
                    SELECT NOMBRE
                    FROM tabla_de_clientes;
        DECLARE CONTINUE HANDLER FOR NOT FOUND
            SET fin_c=1;
        OPEN c;
            WHILE fin_c=0
                DO
                    FETCH c INTO vnombre;
                    IF fin_c=0 THEN SELECT vnombre;
                    END IF;
                END WHILE;
        CLOSE c;
    END$$
    DELIMITER ;
```


### CURSOR CON MAS DE 1 CAMPO

```sql
    DELIMITER $$
        CREATE PROCEDURE `cursor_looping_varios_campos`()
        BEGIN
            DECLARE fin_c INT DEFAULT 0;
            DECLARE vbarrio, vciudad, vestado, vcp VARCHAR(50);
            DECLARE vnombre, vdireccion VARCHAR(150);
            DECLARE c CURSOR FOR SELECT NOMBRE, DIRECCION_1, BARRIO, CIUDAD, ESTADO, CP FROM tabla_de_clientes;
            DECLARE CONTINUE HANDLER FOR NOT FOUND
            SET fin_c = 1;
            OPEN c;
                WHILE fin_c = 0
                    DO
                    FETCH c INTO vnombre, vdireccion, vbarrio, vciudad, vestado, vcp;
                    IF fin_c = 0 
                        THEN SELECT CONCAT(vnombre, ' Dirección: ', vdireccion, " - ", vbarrio, ' - ', vciudad, ' - ', vestado, ' - ',vcp) AS RESULTADO;
                    END IF;
                END WHILE;
            CLOSE c;
        END$$
    DELIMITER ;
```

![Cursor con mas campos](/imagenes/clase05/cursor_varios_campos.png)


## FUNCIONES

- Siempre devuelve un resultado
- Es necesario configurar una variable global
    - SET GLOBAL log_bin_trust_function_creators=1;
    - Ya que normalmente la instalacion de mysql no permite que los usuarios creen funciones

```sql
    CREATE  FUNCTION nombre_funcion(parametros)
            RETURNS datatype;
            BEGIN
                DECLARE variables;
                codigo;
                RETURN resultado;
            END;
```

Ejemplo con la BD Jugos:

```sql
    USE `credicel_alura_bd`;
    DROP function IF EXISTS `f_define_sabor`;
    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE FUNCTION `f_define_sabor` (vsabor VARCHAR(40))
        RETURNS VARCHAR(40)
        BEGIN
            DECLARE vretorno VARCHAR(40) DEFAULT '';
            DECLARE mensaje VARCHAR(20);
            CASE 	vsabor
                    WHEN 'Maracuya' THEN SET mensaje='Sabor Rico';
                    WHEN 'Frutilla' THEN SET mensaje='Sabor Rico';
                    WHEN 'Limon' THEN SET mensaje='Sabor Rico';
                    WHEN 'Sandia' THEN SET mensaje='Sabor Rico';
                    WHEN 'Mango' THEN SET mensaje='Sabor Rico';
            ELSE SET mensaje='Sabor Comun';
            END CASE;
            RETURN mensaje;
        END$$
    DELIMITER ;
```

![Usando Funcion](/imagenes/clase05/usando_funcion.png)

La funcion se puede usar en un where:

```sql
    SELECT 
        NOMBRE_DEL_PRODUCTO,
        SABOR,
        f_define_sabor(SABOR) as tipo
    FROM credicel_alura_bd.tabla_de_productos
    WHERE f_define_sabor(SABOR)='Sabor Comun';
```

![Funcion en Where](/imagenes/clase05/funcion_en_where.png)


