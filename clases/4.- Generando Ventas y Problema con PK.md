## Generando Ventas y problema con PK

- crear un procedimiento que genere una venta, usando las funciones de datos aleatorios

```sql
    USE `credicel_empresa`;
    DROP procedure IF EXISTS `sp_venta`;

    DELIMITER $$
        USE `credicel_empresa`$$
        CREATE PROCEDURE `sp_venta` (fecha DATE,
                                    maxitems INT,
                                    maxcantidad INT)
        BEGIN
            DECLARE vcliente VARCHAR(20);
            DECLARE vproducto VARCHAR(20);
            DECLARE vvendedor VARCHAR(20);
            DECLARE vcantidad INT;
            DECLARE vprecio FLOAT;
            DECLARE vitems INT;
            DECLARE vnfactura INT;
            DECLARE vcontador INT DEFAULT 1;
            -- Buscamos la factura maxima y le sumamos 1 para obtener el nuevo numero
            SELECT (MAX(NUMERO)+1) INTO vnfactura FROM facturas;
            -- buscamos los datos aleatorios
            SET vcliente= f_cliente_aleatorio();
            SET vvendedor=f_vendedor_aleatorio();
            -- generando la factura, asume 6% el impuesto
            INSERT INTO facturas(NUMERO, 
                                FECHA, 
                                DNI, 
                                MATRICULA, 
                                IMPUESTO) 
                        VALUES (vnfactura,
                                fecha,
                                vcliente,
                                vvendedor,
                                0.16);
            SET vitems=f_aleatorio(1,maxitems);
            -- generando los items aleatorios
            WHILE vcontador <= vitems
            DO
                SET vproducto=f_producto_aleatorio();
                SET vcantidad=f_aleatorio(1, maxcantidad);
                SELECT PRECIO INTO vprecio 
                    FROM productos
                    WHERE CODIGO=vproducto;
                INSERT INTO items(NUMERO,
                                CODIGO,
                                CANTIDAD,
                                PRECIO) 
                            VALUES(vnfactura,
                                vproducto,
                                vcantidad,
                                vprecio);
                SET vcontador=vcontador+1;
            END WHILE;
        END$$

    DELIMITER ;

```

El codigo anterior genera el siguiente error:

```sql
    Error Code: 1062. Duplicate entry '10000' for key 'PRIMARY'
```

- El instructor da como solucion definir las llaves primarias como int, implica borrar las tablas y crearlas de nuevo.
- No estoy de acuerdo con esa solucion, en la vida real cambiar tablas puede traernos muchas dificultades
- En mi caso recomiendo Castear
- Con: ** MAX(CAST(numero_factura AS UNSIGNED))**
- Verificada funciona OK


```sql
    USE `credicel_empresa`;
    DROP procedure IF EXISTS `sp_venta`;
    USE `credicel_empresa`;
    DROP procedure IF EXISTS `credicel_empresa`.`sp_venta`;
    ;
    DELIMITER $$
        USE `credicel_empresa`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` PROCEDURE `sp_venta`(fecha DATE,
                                    maxitems INT,
                                    maxcantidad INT)
        BEGIN
            DECLARE vcliente VARCHAR(20);
            DECLARE vproducto VARCHAR(20);
            DECLARE vvendedor VARCHAR(20);
            DECLARE vcantidad INT;
            DECLARE vprecio FLOAT;
            DECLARE vitems INT;
            DECLARE vnfactura INT;
            DECLARE vcontador INT DEFAULT 1;
            -- Buscamos la factura maxima y le sumamos 1 para obtener el nuevo numero
            SELECT (MAX(CAST(NUMERO AS UNSIGNED))+1) INTO vnfactura FROM facturas;
            -- buscamos los datos aleatorios
            SET vcliente= f_cliente_aleatorio();
            SET vvendedor=f_vendedor_aleatorio();
            -- generando la factura, asume 6% el impuesto
            INSERT INTO facturas(NUMERO, 
                                FECHA, 
                                DNI, 
                                MATRICULA, 
                                IMPUESTO) 
                        VALUES (vnfactura,
                                fecha,
                                vcliente,
                                vvendedor,
                                0.16);
            SET vitems=f_aleatorio(1,maxitems);
            -- generando los items aleatorios
            WHILE vcontador <= vitems
            DO
                SET vproducto=f_producto_aleatorio();
                SET vcantidad=f_aleatorio(1, maxcantidad);
                SELECT PRECIO INTO vprecio 
                    FROM productos
                    WHERE CODIGO=vproducto;
                INSERT INTO items(NUMERO,
                                CODIGO,
                                CANTIDAD,
                                PRECIO) 
                            VALUES(vnfactura,
                                vproducto,
                                vcantidad,
                                vprecio);
                SET vcontador=vcontador+1;
            END WHILE;
        END$$
    DELIMITER ;
    ;
```
