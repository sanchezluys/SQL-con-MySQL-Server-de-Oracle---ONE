## Control de Flujo

- los procedimientos **no guardan comentarios**

### IF/THEN/ELSE

```sql
    IF  condicion THEN 
        codigo
    ELSE
        codigo2
    END IF;
```

- Da el mismo error del ejercicio anterior,
- La solucion es recibir el parametro con  una codificacion utf8mb3_spanish_ci

```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `verifica_edad`;

    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `credicel_alura_bd`.`verifica_edad`;

    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` PROCEDURE `verifica_edad`(vid VARCHAR(20) COLLATE utf8mb3_spanish_ci)
        BEGIN
            DECLARE vfecha DATE;
            DECLARE mensaje VARCHAR(20);
            SELECT 	FECHA_DE_NACIMIENTO INTO vfecha
            FROM	tabla_de_clientes
            WHERE	DNI=vid;
            -- * 0
            SELECT vfecha AS FECHA_NAC;
            SELECT YEAR(vfecha) AS AÑO;
            IF 	YEAR(vfecha) < 1990
                THEN SET mensaje="es un viejo";
            ELSE	
                SET mensaje="es un joven";
            END IF;
            SELECT mensaje;
        END$$

    DELIMITER ;
```

### IF/THEN/ELSIF/ELSE/END IF

```sql
    IF condicion1 THEN
        codigo1;
    ELSEIF condicion2 THEN
        codigo2;
    ELSE
        codigo3;
    END IF;
```

Código para decir si un producto es economico, caro o ascesible.

```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `credicel_alura_bd`.`califica_precio_producto`;
    DELIMITER $$
    USE `credicel_alura_bd`$$
    CREATE DEFINER=`credicel_alura_portatil`@`%` 
    PROCEDURE `califica_precio_producto`(vcodigo VARCHAR(20) COLLATE utf8mb3_spanish_ci)
    BEGIN
        DECLARE vprecio FLOAT;
        DECLARE mensaje VARCHAR(30);
        SET mensaje='sin mensaje';
        -- **
        SELECT 	PRECIO_DE_LISTA INTO vprecio
        FROM	tabla_de_productos
        WHERE	CODIGO_DEL_PRODUCTO=vcodigo;
        -- **
        SELECT  vprecio as Precio;
        IF 	vprecio < 7	THEN
            SET mensaje='producto economico';
        ELSEIF vprecio >=7  AND vprecio < 12 THEN
            SET mensaje='producto ascesible';
        ELSE
            SET mensaje='producto costoso';
        END IF;
        -- **
        SELECT mensaje as Mensaje;
    END$$
    DELIMITER ;
```

### CASE / END / CASE Control de Flujo

```sql
    CASE selector
    WHEN valor_1 THEN codigo1;
    WHEN valor_2 THEN codigo2;
    -- ***
    ELSE codigo_else;
    END CASE;
```

Realizar un codigo que califique:

- Maracuya Rico,
- Frutilla Rico,
- Limon Rico,
- Sandia Rico,
- Mango Rico,
- Los demas son comunes


```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `calificar_jugo`;

    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `credicel_alura_bd`.`calificar_jugo`;
    ;

    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` PROCEDURE `calificar_jugo`(vcodigo VARCHAR(20) COLLATE utf8mb3_spanish_ci)
        BEGIN
            DECLARE mensaje VARCHAR(20);
            DECLARE vsabor VARCHAR(20);
            SELECT 	SABOR INTO vsabor
                    FROM tabla_de_productos
                    WHERE vcodigo=CODIGO_DEL_PRODUCTO;
            SELECT	vsabor as Sabor;
            CASE 	vsabor
                    WHEN 'Maracuya' THEN SET mensaje='Sabor Rico';
                    WHEN 'Frutilla' THEN SET mensaje='Sabor Rico';
                    WHEN 'Limon' THEN SET mensaje='Sabor Rico';
                    WHEN 'Sandia' THEN SET mensaje='Sabor Rico';
                    WHEN 'Mango' THEN SET mensaje='Sabor Rico';
                ELSE SET mensaje='Sabor Comun';
            END CASE;
            -- **
            SELECT mensaje as Mensaje;
        END
        /*
        - Maracuya Rico,
        - Frutilla Rico,
        - Limon Rico,
        - Sandia Rico,
        - Mango Rico,
        - Los demas son comunes
        */$$
    DELIMITER ;
    ;
```

### CASE NOT FOUND

- Para casos en que por ejemplo el caso no exista se puede generar un error
- manejo del error, por ejemplo 
  - 1318: procedimiento sin parametro
  - 1339: error **CASE NOT FOUND**
- Se usa: **DECLARE CONTINUO HANDLER FOR 1339**

```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `credicel_alura_bd`.`calificar_jugo_error`;
    ;
    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` 
        PROCEDURE `calificar_jugo_error`(vcodigo VARCHAR(20) COLLATE utf8mb3_spanish_ci)
        BEGIN
            DECLARE mensaje VARCHAR(50);
            DECLARE vsabor VARCHAR(20);
            /* manejo del error */
            DECLARE CONTINUE HANDLER FOR 1339
                BEGIN
                    SET mensaje='Error! ese sabor no tiene caso asosiado';
                END;
            /**************************/
            SELECT 	SABOR INTO vsabor
                    FROM tabla_de_productos
                    WHERE vcodigo=CODIGO_DEL_PRODUCTO;
            SELECT	vsabor as Sabor;
            CASE 	vsabor
                    WHEN 'Maracuya' THEN SET mensaje='Sabor Rico';
                    WHEN 'Frutilla' THEN SET mensaje='Sabor Rico';
                    WHEN 'Limon' THEN SET mensaje='Sabor Rico';
                    WHEN 'Sandia' THEN SET mensaje='Sabor Rico';
                    WHEN 'Mango' THEN SET mensaje='Sabor Rico';
            END CASE;
            -- **
            SELECT mensaje as Mensaje;
        END$$
    DELIMITER ;
    ;
```

### CASE CONDICIONAL

- CASE es mas eficiente que IF/THEN/ELSE

```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `califica_precio_producto_con_case`;
    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE PROCEDURE `califica_precio_producto_con_case` (vcodigo VARCHAR(20) COLLATE utf8mb3_spanish_ci)
        BEGIN
            DECLARE vprecio FLOAT;
            DECLARE mensaje VARCHAR(30);
            SET mensaje='sin mensaje';
            SELECT 	PRECIO_DE_LISTA INTO vprecio
            FROM	tabla_de_productos
            WHERE	CODIGO_DEL_PRODUCTO=vcodigo;
            SELECT  vprecio as Precio;
            CASE
                WHEN vprecio < 7 THEN SET mensaje='producto economico';
                WHEN (vprecio >=7  AND vprecio < 12) THEN SET mensaje='producto ascesible';
                WHEN vprecio > 12 THEN SET mensaje='producto costoso';
            END CASE;
            SELECT mensaje as Mensaje;
        END$$
    DELIMITER;
```

### Bucles, LOOPING

- WHILE

```sql
    WHILE condicion
        DO
            codigo;
        END WHILE;
```
- Primero se crea una tabla auxiliar para agregar alli los resultados del bucle

```sql
    CREATE TABLE `credicel_alura_bd`.`tabla_loop` (
        `id` INT NOT NULL AUTO_INCREMENT,
        `valor` INT NULL,
    PRIMARY KEY (`id`))
        ENGINE = InnoDB
        DEFAULT CHARACTER SET = utf8
        COLLATE = utf8_spanish_ci
        COMMENT = 'para usar el bucle while do';
```

- Luego el codigo:

```sql
    USE `credicel_alura_bd`;
    DROP procedure IF EXISTS `credicel_alura_bd`.`looping`;
    ;

    DELIMITER $$
        USE `credicel_alura_bd`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` PROCEDURE `looping`(vini INT, vfin INT)
        BEGIN
            DECLARE cuenta INT;
            DELETE FROM tabla_loop;
            WHILE 	vini <= vfin
                    DO
                        INSERT INTO `tabla_loop` (`valor`) VALUES (vini);
                        SET vini=vini+1;
                    END WHILE;
            SELECT * FROM tabla_loop;
        END$$

    DELIMITER ;
;
```