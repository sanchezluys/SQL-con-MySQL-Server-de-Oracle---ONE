## Stored Procedures y Triggers

- Revisando el acumulado de la facturacion

```sql
    -- ACUMULADO DE FACTURACION
    --
    SELECT 	F.FECHA,
            I.CANTIDAD,
            I.PRECIO,
            FLOOR(SUM(I.CANTIDAD*I.PRECIO)) AS FACTURACION
    FROM credicel_empresa.facturas F
    JOIN items I ON I.NUMERO=F.NUMERO
    WHERE YEAR(F.FECHA)=2024
    GROUP BY F.FECHA;

```

- Errores que se presentan
  - Cuando se usa el SP con 20 articulos y se sabe que existen 24 articulos, entonces es muy probable que los articulos se repitan en los items causando un error de llave primaria.

### TRIGGERS

- Como se sabe los triggers se puden definir para un update, delete o insert en las tablas,
- Si se elabora un trigger por cada caso en una tabla entonces se hace dificil su mantenimiento con el tiempo y sobre todo si se piden actualizaciones por reglas del negocio.
- Por lo anterior se recomienda que el trigger dispare un procedimiento que revise cada caso.
- Se usa el archivo triggers.sql de los recursos/sql
- Al ejecutarse el sql de ese archivo se crea la tabla de facturacion con los 3 triggers asosciados a los cambios en la tabla items
- Se puede observar que el codigo es el mismo en cada trigger, por lo que ese codigo puede ser agregado en un nuevo procedimiento y que cada trigger llame al mismo procedimiento

Creando el SP para delete/update/insert

```sql
    -- PARA DELETE
    DROP TRIGGER IF EXISTS `credicel_empresa`.`TG_FACTURACION_DELETE`;

    DELIMITER $$
        USE `credicel_empresa`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` TRIGGER TG_FACTURACION_DELETE
        AFTER DELETE ON items
        FOR EACH ROW BEGIN
        CALL sp_triggers;
        END$$
    DELIMITER ;

```

```sql
    -- PARA INSERT
    DROP TRIGGER IF EXISTS `credicel_empresa`.`TG_FACTURACION_INSERT`;
    DELIMITER $$
        USE `credicel_empresa`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` TRIGGER TG_FACTURACION_INSERT 
        AFTER INSERT ON items
        FOR EACH ROW BEGIN
        CALL sp_triggers;
        END$$
    DELIMITER ;
```


```sql
    -- PARA UPDATE
    DROP TRIGGER IF EXISTS `credicel_empresa`.`TG_FACTURACION_UPDATE`;

    DELIMITER $$
        USE `credicel_empresa`$$
        CREATE DEFINER=`credicel_alura_portatil`@`%` TRIGGER TG_FACTURACION_UPDATE
        AFTER UPDATE ON items
        FOR EACH ROW BEGIN
        CALL sp_triggers;
        END$$
    DELIMITER ;

```

Para editar los triggers:

![Editar Triggers](/imagenes/clase05/editar_trigger.png)

Codigo final ajustado para cuando ingresan varios productos iguales en la misma factura:

![Codigo Final agregar Venta](/imagenes/clase05/codigo_final_agregar_venta.png)